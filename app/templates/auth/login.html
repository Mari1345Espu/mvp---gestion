<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Login - Observatorio UDEC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f7f7fa; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-box { background: #fff; border-radius: 12px; box-shadow: 0 0 24px #0001; padding: 2.5rem 2rem; }
        .login-logo { width: 120px; margin-bottom: 1rem; }
        .side-img { background: #f1f1f5; display: flex; align-items: center; justify-content: center; }
        .side-img svg { width: 180px; height: 180px; opacity: 0.3; }
    </style>
</head>
<body>
<div class="container-fluid login-container">
    <div class="row w-100">
        <div class="col-md-5 d-flex justify-content-center align-items-center">
            <div class="login-box w-100" style="max-width: 350px;">
                <div class="text-center">
                    <img src="{{ url_for('static', path='/img/logo.png') }}" class="login-logo" alt="Logo UDEC">
                </div>
                <h4 class="text-center mb-4">OBSERVATORIO</h4>
                <form id="loginForm">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="username" name="username" placeholder="Nombre de usuario" required>
                    </div>
                    <div class="mb-3 position-relative">
                        <input type="password" class="form-control" id="password" name="password" placeholder="Contraseña" required>
                        <button type="button" class="btn btn-outline-secondary btn-sm position-absolute top-50 end-0 translate-middle-y me-2" style="z-index:2;" onclick="togglePassword('password', this)"><i class="fa fa-eye"></i></button>
                    </div>
                    <button type="submit" class="btn btn-success w-100 mb-2">Acceder</button>
                </form>
                <div class="text-center">
                    <a href="/recuperar-password" class="text-success">¿Olvidó su contraseña?</a>
                    <br>
                    <a href="/registro" class="text-success">¿No tienes cuenta? Regístrate aquí</a>
                </div>
                <div id="loginError" class="alert alert-danger mt-3 d-none"></div>
            </div>
        </div>
        <div class="col-md-7 side-img d-none d-md-flex">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 200 200"><circle cx="100" cy="100" r="80" fill="#bbb"/></svg>
        </div>
    </div>
</div>
<script>
// Decodificar JWT para obtener el rol
function parseJwt (token) {
    try {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
        return JSON.parse(jsonPayload);
    } catch (e) {
        return null;
    }
}

document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('loginError');
    errorDiv.classList.add('d-none');
    
    try {
        const response = await fetch('/api/v1/token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ username, password })
        });
        if (response.ok) {
            const result = await response.json();
            localStorage.setItem('token', result.access_token);
            window.location.href = '/dashboard.html';
        } else {
            const err = await response.json();
            errorDiv.textContent = err.detail || 'Error de autenticación';
            errorDiv.classList.remove('d-none');
        }
    } catch (err) {
        errorDiv.textContent = 'Error de red o del servidor';
        errorDiv.classList.remove('d-none');
    }
});

function togglePassword(inputId, btn) {
    const input = document.getElementById(inputId);
    if (input.type === 'password') {
        input.type = 'text';
        btn.innerHTML = '<i class="fa fa-eye-slash"></i>';
    } else {
        input.type = 'password';
        btn.innerHTML = '<i class="fa fa-eye"></i>';
    }
}
</script>
</body>
</html> 