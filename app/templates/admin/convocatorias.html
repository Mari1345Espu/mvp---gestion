{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Gestión de Convocatorias</h2>
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-white bg-primary mb-3">
        <div class="card-body">
          <h5 class="card-title">Total de Convocatorias</h5>
          <p class="card-text display-6" id="total-convocatorias">{{ total_convocatorias }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-success mb-3">
        <div class="card-body">
          <h5 class="card-title">Convocatorias Abiertas</h5>
          <p class="card-text display-6" id="abiertas">{{ abiertas }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-white bg-secondary mb-3">
        <div class="card-body">
          <h5 class="card-title">Convocatorias Cerradas</h5>
          <p class="card-text display-6" id="cerradas">{{ cerradas }}</p>
        </div>
      </div>
    </div>
  </div>
  <div class="mb-3 text-end">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCrear">Crear Nueva Convocatoria</button>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered table-hover" id="tabla-convocatorias">
      <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Fecha de Inicio</th>
          <th>Fecha de Fin</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbody-convocatorias">
        {% for c in convocatorias %}
        <tr data-id="{{ c.id }}">
          <td>{{ c.id }}</td>
          <td>{{ c.nombre }}</td>
          <td>{{ c.fecha_inicio.strftime('%Y-%m-%d') if c.fecha_inicio else '' }}</td>
          <td>{{ c.fecha_fin.strftime('%Y-%m-%d') if c.fecha_fin else '' }}</td>
          <td>{{ c.estado.nombre if c.estado else '' }}</td>
          <td>
            <button class="btn btn-sm btn-primary btn-editar" data-id="{{ c.id }}">Editar</button>
            <button class="btn btn-sm btn-danger btn-eliminar" data-id="{{ c.id }}">Eliminar</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Crear -->
<div class="modal fade" id="modalCrear" tabindex="-1" aria-labelledby="modalCrearLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form-crear">
        <div class="modal-header">
          <h5 class="modal-title" id="modalCrearLabel">Crear Convocatoria</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label>Nombre</label>
            <input type="text" class="form-control" name="nombre" required>
          </div>
          <div class="mb-3">
            <label>Fecha de Inicio</label>
            <input type="date" class="form-control" name="fecha_inicio" required>
          </div>
          <div class="mb-3">
            <label>Fecha de Fin</label>
            <input type="date" class="form-control" name="fecha_fin" required>
          </div>
          <div class="mb-3">
            <label>Estado</label>
            <select class="form-select" name="estado_id" required>
              {% for estado in estados %}
                <option value="{{ estado.id }}">{{ estado.nombre }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Crear</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Editar -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form-editar">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarLabel">Editar Convocatoria</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="editar-id">
          <div class="mb-3">
            <label>Nombre</label>
            <input type="text" class="form-control" name="nombre" id="editar-nombre" required>
          </div>
          <div class="mb-3">
            <label>Fecha de Inicio</label>
            <input type="date" class="form-control" name="fecha_inicio" id="editar-fecha-inicio" required>
          </div>
          <div class="mb-3">
            <label>Fecha de Fin</label>
            <input type="date" class="form-control" name="fecha_fin" id="editar-fecha-fin" required>
          </div>
          <div class="mb-3">
            <label>Estado</label>
            <select class="form-select" name="estado_id" id="editar-estado" required>
              {% for estado in estados %}
                <option value="{{ estado.id }}">{{ estado.nombre }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const token = localStorage.getItem('token');
const apiUrl = '/api/v1/convocatorias/';

function fetchConvocatorias() {
  fetch(apiUrl, {
    headers: { 'Authorization': 'Bearer ' + token }
  })
    .then(r => r.json())
    .then(data => renderConvocatorias(data));
}

function renderConvocatorias(convocatorias) {
  const tbody = document.getElementById('tbody-convocatorias');
  tbody.innerHTML = '';
  let total = 0, abiertas = 0, cerradas = 0;
  convocatorias.forEach(c => {
    total++;
    if (c.estado && c.estado.nombre && c.estado.nombre.toLowerCase() === 'abierta') abiertas++;
    if (c.estado && c.estado.nombre && c.estado.nombre.toLowerCase() === 'cerrada') cerradas++;
    const tr = document.createElement('tr');
    tr.setAttribute('data-id', c.id);
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.nombre}</td>
      <td>${c.fecha_inicio ? c.fecha_inicio.substring(0,10) : ''}</td>
      <td>${c.fecha_fin ? c.fecha_fin.substring(0,10) : ''}</td>
      <td>${c.estado && c.estado.nombre ? c.estado.nombre : ''}</td>
      <td>
        <button class="btn btn-sm btn-primary btn-editar" data-id="${c.id}">Editar</button>
        <button class="btn btn-sm btn-danger btn-eliminar" data-id="${c.id}">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  document.getElementById('total-convocatorias').textContent = total;
  document.getElementById('abiertas').textContent = abiertas;
  document.getElementById('cerradas').textContent = cerradas;
}

// Crear convocatoria
const formCrear = document.getElementById('form-crear');
formCrear.addEventListener('submit', async function(e) {
  e.preventDefault();
  const formData = new FormData(formCrear);
  const data = Object.fromEntries(formData.entries());
  data.estado_id = parseInt(data.estado_id);
  const resp = await fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify(data)
  });
  if (resp.ok) {
    bootstrap.Modal.getInstance(document.getElementById('modalCrear')).hide();
    formCrear.reset();
    fetchConvocatorias();
  } else {
    alert('Error al crear convocatoria');
  }
});

// Editar convocatoria (abrir modal)
document.getElementById('tbody-convocatorias').addEventListener('click', function(e) {
  if (e.target.classList.contains('btn-editar')) {
    const id = e.target.getAttribute('data-id');
    fetch(apiUrl + id, {
      headers: { 'Authorization': 'Bearer ' + token }
    })
      .then(r => r.json())
      .then(c => {
        document.getElementById('editar-id').value = c.id;
        document.getElementById('editar-nombre').value = c.nombre;
        document.getElementById('editar-fecha-inicio').value = c.fecha_inicio ? c.fecha_inicio.substring(0,10) : '';
        document.getElementById('editar-fecha-fin').value = c.fecha_fin ? c.fecha_fin.substring(0,10) : '';
        document.getElementById('editar-estado').value = c.estado_id;
        new bootstrap.Modal(document.getElementById('modalEditar')).show();
      });
  }
  // Eliminar convocatoria
  if (e.target.classList.contains('btn-eliminar')) {
    const id = e.target.getAttribute('data-id');
    if (confirm('¿Seguro que deseas eliminar esta convocatoria?')) {
      fetch(apiUrl + id, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      }).then(resp => {
        if (resp.ok) fetchConvocatorias();
        else alert('Error al eliminar convocatoria');
      });
    }
  }
});

// Guardar edición
document.getElementById('form-editar').addEventListener('submit', async function(e) {
  e.preventDefault();
  const id = document.getElementById('editar-id').value;
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());
  data.estado_id = parseInt(data.estado_id);
  const resp = await fetch(apiUrl + id, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify(data)
  });
  if (resp.ok) {
    bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
    fetchConvocatorias();
  } else {
    alert('Error al editar convocatoria');
  }
});

// Inicializar
fetchConvocatorias();
</script>
{% endblock %} 